---
title: "dndsR: Quickstart Workflow"
author: "Nicholas A. Johnson"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{dndsR: Quickstart Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  message = FALSE,
  warning = FALSE,
  error = FALSE
)
```

## Introduction

Still under development.

This vignette demonstrates the end-to-end workflow supported by `dndsR`:

1. Split a comparison file into subgenome-specific comparisons (optional).
2. Extract CDS from genome FASTA + GFF3.
3. Compute dN/dS (may require external tools; typically slower).
4. Append gene and feature annotations.
5. Perform functional term enrichment (InterPro, GO, or other annotations).
6. Visualize results (e.g., ideograms; optional).

To ensure the vignette is **CRAN-safe**, reproducible, and fast during `R CMD check`, it uses:
- small bundled example inputs, and
- precomputed example outputs for compute-heavy steps.

For real analyses, users should run the same functions on full genomes and annotations.

## Load package

```{r}
library(dndsR)
```

## Example data bundled with the package

All files used in this vignette are loaded from `inst/extdata/` using `system.file()`.

Expected example files:

- `example_comparison_file.txt`
- `example_comparison_file_split.txt` (optional)
- `example_dnds.tsv`
- `example_dnds_annot.tsv`
- small FASTA and GFF3 slices referenced by the comparison file

```{r example-paths}
ext <- system.file("extdata", package = "dndsR")
stopifnot(nzchar(ext))

comparison_file          <- file.path(ext, "example_comparison_file.txt")
comparison_file_split    <- file.path(ext, "example_comparison_file_split.txt")
example_dnds  <- file.path(ext, "example_dnds.tsv")
example_annot <- file.path(ext, "example_dnds_annot.tsv")

file.exists(c(comparison_file, comparison_file_split, example_dnds, example_annot))
```

## 1) Split comparison file by subgenome (optional)

If a combined comparison file is provided, `split_comparisons()` can generate subgenome-specific comparison files (e.g., B/C/D). This step is shown for reference only and is not executed during vignette rendering.

```{r split-comparisons, eval=FALSE}
split_comparisons(
  comparison_file = comparison_file,
  mode = "subgenome"
)
```

For the remainder of this vignette, we use:

```{r}
comparison_file_in_use <- if (file.exists(comparison_file_split)) comparison_file_split else comparison_file
comparison_file_in_use
```

## 2) Extract CDS

`extract_cds()` extracts coding sequences (or proteins) from genome FASTA and GFF3 paths defined in the comparison file.

```{r extract-cds}
out_dir <- tempdir()

cds_out <- extract_cds(
  comparison_file = comparison_file_in_use,
  output_dir = out_dir
)

cds_out
```

## 3) Calculate dN/dS (shown, not run)

Calculating dN/dS relies on external tools (DIAMOND2 and OrthoFinder) and can be computationally intensive. The call below is shown for reference but not executed during this vignette.

```{r calculate-dnds, eval=FALSE}
calculate_dnds(
  comparison_file = comparison_file_in_use,
  output_dir = out_dir,
  comp_cores = 4,
  aligner = "diamond",
  sensitivity_mode = "fast",
  dnds_method = "Comeron"
)
```

Instead, we load a small pre-computed example result matching the output format of `calculate_dnds()`:

```{r load-precomputed-dnds}
dnds <- read.delim(example_dnds, sep = "\t", header = TRUE, stringsAsFactors = FALSE)
head(dnds)
```

## 4) Append annotations

To keep the vignette fast and deterministic, we load a precomputed annotated table:

```{r load-precomputed-annot}
dnds_annot <- read.delim(example_annot, sep = "\t", header = TRUE, stringsAsFactors = FALSE)
head(dnds_annot)
```

Typical usage is shown below:

```{r append-annotations, eval=FALSE}
append_annotations(
  comparison_file = comparison_file_in_use,
  output_dir = out_dir
)
```

## 5) Generic term enrichment (shown, not run)

```{r term-enrichment, eval=FALSE}
term_enrichment(
  comparison_file = comparison_file_in_use,
  output_dir = out_dir,
  terms = NULL,
  sides = c("query", "subject"),
  pos_threshold = 1,
  drop_rows_without_term = TRUE,
  min_total = 10,
  min_pos   = 2
)
```

## 6) GO enrichment (shown, not run)

```{r go-enrichment, eval=FALSE}
go_enrichment(
  comparison_file = comparison_file_in_use,
  output_dir = out_dir,
  sides = c("query", "subject"),
  ontologies = c("BP", "MF", "CC"),
  algorithm  = "weight01",
  statistic  = "fisher",
  pos_threshold = 1,
  drop_rows_without_go = TRUE,
  node_min = 5,
  make_plots = TRUE,
  top_n = 20
)
```

## 7) InterPro enrichment (shown, not run)

Network access is disabled during CRAN checks. This step is shown for reference only.

```{r ipr-enrichment, eval=FALSE}
ipr_enrichment(
  comparison_file = comparison_file_in_use,
  output_dir = out_dir,
  stratify_by_type = TRUE,
  min_pos = 2,
  min_total = 10,
  pos_threshold = 1.1
)
```

## 8) dN/dS ideogram

```{r dnds-ideogram, eval=FALSE}
dnds_ideogram(
  comparison_file = comparison_file_in_use,
  output_dir = out_dir
)
```

## 9) dN/dS contrasts and summaries
Will add commands once these scripts are in a stable form, currently regional_contrasts and summary.

## Summary

This vignette demonstrates the `dndsR` workflow in a reproducible manner while still showing the real function calls used for full analyses.
