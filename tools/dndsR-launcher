#!/usr/bin/env bash
set -euo pipefail

die(){ echo "Error: $*" >&2; exit 1; }
have(){ command -v "$1" >/dev/null 2>&1; }

# -----------------------------
# Resolve directory of this script (even if invoked via symlink/relative path)
# -----------------------------
SCRIPT_SOURCE="${BASH_SOURCE[0]:-$0}"
while [ -h "$SCRIPT_SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)"
  SCRIPT_SOURCE="$(readlink "$SCRIPT_SOURCE")"
  [[ $SCRIPT_SOURCE != /* ]] && SCRIPT_SOURCE="$DIR/$SCRIPT_SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)"

# -----------------------------
# Container guard (default ON)
# -----------------------------
# Set DNDSR_ALLOW_HOST=1 to bypass (advanced users installing deps locally).
DNDSR_ALLOW_HOST="${DNDSR_ALLOW_HOST:-0}"

in_container(){
  # Apptainer/Singularity commonly set these
  if [[ -n "${APPTAINER_NAME:-}" || -n "${SINGULARITY_NAME:-}" || -n "${SINGULARITY_CONTAINER:-}" ]]; then
    return 0
  fi
  # Docker often has this file
  if [[ -f "/.dockerenv" ]]; then
    return 0
  fi
  return 1
}

require_container(){
  if [[ "$DNDSR_ALLOW_HOST" -eq 1 ]]; then
    return 0
  fi
  if ! in_container; then
    die "This launcher is intended to be run inside a container (Singularity/Apptainer or Docker).

Recommended:
  singularity exec /path/dndsr.sif tools/dndsR-launcher run <command> [args...]

If you really want to run on the host (advanced; you must install all external dependencies yourself),
set DNDSR_ALLOW_HOST=1."
  fi
}

# -----------------------------
# Repo root discovery (standard R package layout)
# -----------------------------
infer_repo_root() {
  [[ -n "${REPO_DIR:-}" ]] && { echo "$REPO_DIR"; return 0; }

  local d="$SCRIPT_DIR"
  for _ in 0 1 2 3 4 5; do
    if [[ -f "${d}/DESCRIPTION" && -d "${d}/R" ]]; then
      echo "$d"
      return 0
    fi
    d="$(cd "${d}/.." && pwd)"
  done
  echo ""
}

REPO_DIR="$(infer_repo_root)"
[[ -n "$REPO_DIR" ]] || die "Could not infer repo root from launcher path ($SCRIPT_DIR).
Set REPO_DIR=/path/to/dndsR (directory containing DESCRIPTION and R/)."

PKG_NAME="dndsR"

[[ -f "${REPO_DIR}/DESCRIPTION" ]] || die "No DESCRIPTION at ${REPO_DIR}/DESCRIPTION"
[[ -d "${REPO_DIR}/R" ]]          || die "No R/ directory at ${REPO_DIR}/R"

# Default install location (mounted home inside container)
HOST_RLIB="${HOST_RLIB:-${HOME:-}/.dndsr/rlib}"

# Force reinstall (flag or env)
FORCE="${DNDSR_FORCE:-0}"

usage(){
cat <<'EOF'
dndsR-launcher â€” install and run the dndsR CLI (container-first)

USAGE
  dndsR-launcher [--force] install
  dndsR-launcher [--force] run [<dndsr command> [args...]]
  dndsR-launcher doctor
  dndsR-launcher --help

NOTES
  - Intended to be run inside Singularity/Apptainer or Docker.
  - dndsR is installed into a user library (default: ~/.dndsr/rlib), which should be mounted inside the container.
  - If you run on the host (advanced), you must install all external tool dependencies yourself.
    To bypass the container guard: DNDSR_ALLOW_HOST=1

ENV (optional)
  HOST_RLIB           R library for dndsR (default: ~/.dndsr/rlib)
  REPO_DIR            repo root containing DESCRIPTION (standard R package layout)
  DNDSR_FORCE=1       force reinstall
  DNDSR_ALLOW_HOST=1  allow running launcher on host (advanced)

EXAMPLES (Singularity/Apptainer)
  singularity exec dndsr.sif tools/dndsR-launcher install
  singularity exec dndsr.sif tools/dndsR-launcher run --help
  singularity exec dndsr.sif tools/dndsR-launcher run calculate_dnds --threads 16

EXAMPLES (Docker)
  docker run --rm -v "$PWD:/data" -w /data scrumpis/dndsr:TAG tools/dndsR-launcher run calculate_dnds --threads 16
EOF
}

# -----------------------------
# Source hash for "install only when changed"
# -----------------------------
src_hash(){
  local SUM=""
  have sha256sum && SUM="sha256sum" || have shasum && SUM="shasum -a 256" || SUM="md5sum"
  (
    cd "${REPO_DIR}" || exit 1
    find DESCRIPTION NAMESPACE R inst man tools -type f 2>/dev/null \
      | LC_ALL=C sort \
      | xargs ${SUM} \
      | ${SUM%% *} \
      | awk '{print $1}'
  )
}

# -----------------------------
# Resolve installed runner (preferred exec script)
# -----------------------------
resolve_runner(){
  local runner="${HOST_RLIB}/${PKG_NAME}/exec/dndsr"
  if [[ -x "$runner" ]]; then
    echo "$runner"
    return 0
  fi

  have Rscript || die "Rscript not found in PATH and installed runner missing at ${runner}"
  # Fallback: call cli_main directly
  echo "Rscript --vanilla -e dndsR::cli_main --"
}

# -----------------------------
# Install (or update) dndsR into user lib
# -----------------------------
install_pkg_if_needed(){
  # Prevent bspm activity (rocker/r2u etc.)
  export R_PROFILE=/dev/null
  export R_PROFILE_USER=/dev/null
  export R_ENVIRON_USER=/dev/null
  export BSPM_DISABLE=1

  have R || die "R not found in PATH"
  have Rscript || die "Rscript not found in PATH"

  [[ -n "${HOST_RLIB}" ]] || die "HOST_RLIB is empty; set HOST_RLIB or HOME"
  mkdir -p "${HOST_RLIB}" || die "Failed to create ${HOST_RLIB}"
  [[ -w "${HOST_RLIB}" ]] || die "User library not writable: ${HOST_RLIB}"

  local desc="${REPO_DIR}/DESCRIPTION"
  [[ -f "$desc" ]] || die "No DESCRIPTION at ${desc}"

  local ver; ver="$(awk -F': *' '$1=="Version"{print $2}' "$desc")"
  [[ -n "$ver" ]] || die "Could not parse Version from DESCRIPTION"

  local hash; hash="$(src_hash || true)"
  [[ -n "$hash" ]] || echo "Warning: could not compute source hash; falling back to version only." >&2

  local meta="${HOST_RLIB}/.${PKG_NAME}.installmeta"
  local need=1
  if [[ -f "$meta" ]]; then
    read -r prev_ver prev_hash < "$meta" || true
    if [[ "${FORCE}" -eq 0 && "${prev_ver:-}" == "$ver" && ( -z "$hash" || "${prev_hash:-}" == "$hash" ) ]]; then
      need=0
    fi
  fi

  if [[ "${FORCE}" -eq 1 ]]; then
    echo "[${PKG_NAME}] FORCE reinstall requested."
    need=1
  fi

  if [[ "$need" -eq 0 ]]; then
    echo "[${PKG_NAME}] ${ver} already installed in ${HOST_RLIB} (hash match)."
  else
    echo "[${PKG_NAME}] Installing ${ver} into ${HOST_RLIB} ..."
    R CMD REMOVE -l "${HOST_RLIB}" "${PKG_NAME}" >/dev/null 2>&1 || true
    Rscript --vanilla -e "install.packages(normalizePath('${REPO_DIR}'), repos=NULL, type='source', lib='${HOST_RLIB}', INSTALL_opts=c('--clean','--preclean'))"
    echo "${ver} ${hash:-nohash}" > "$meta"
  fi

  R_LIBS_USER="${HOST_RLIB}" Rscript --vanilla - <<'RS'
opts <- options(warn=1); on.exit(options(opts), add=TRUE)
.libPaths(c(Sys.getenv("R_LIBS_USER"), .libPaths()))
suppressPackageStartupMessages(library(dndsR))
cat(sprintf("dndsR version: %s\n", as.character(packageVersion("dndsR"))))
cat("libPaths:\n"); print(.libPaths())
RS
}

# -----------------------------
# Parse flags + command
# -----------------------------
cmd=""
while [[ $# -gt 0 ]]; do
  case "$1" in
    --force) FORCE=1; shift ;;
    install|run|doctor) cmd="$1"; shift; break ;;
    -h|--help) usage; exit 0 ;;
    *) usage; die "Unknown argument: $1" ;;
  esac
done
[[ -n "${cmd:-}" ]] || { usage; exit 1; }

# -----------------------------
# Commands
# -----------------------------
case "$cmd" in
  install)
    require_container
    install_pkg_if_needed
    echo "Installed/updated $PKG_NAME into $HOST_RLIB"
    echo "CLI executable: ${HOST_RLIB}/${PKG_NAME}/exec/dndsr"
    ;;

  run)
    require_container
    install_pkg_if_needed
    export R_LIBS_USER="$HOST_RLIB"
    export DNDSR_HOME="${REPO_DIR}"
    export DNDSR_REPO="${REPO_DIR}"   # harmless alias

    runner="$(resolve_runner)"

    # If no args, show dndsr help
    if [[ $# -eq 0 ]]; then
      if [[ -x "$runner" ]]; then
        exec "$runner" --help
      else
        # shellcheck disable=SC2086
        exec $runner --help
      fi
    fi

    if [[ -x "$runner" ]]; then
      exec "$runner" "$@"
    else
      # shellcheck disable=SC2086
      exec $runner "$@"
    fi
    ;;

  doctor)
    echo "=== dndsR doctor ==="
    echo "In container:  $(in_container && echo yes || echo no)"
    echo "REPO_DIR:      $REPO_DIR"
    echo "HOST_RLIB:     $HOST_RLIB"
    echo "RUNNER:        $(resolve_runner 2>/dev/null || echo "<not found>")"
    echo "ALLOW_HOST:    $DNDSR_ALLOW_HOST"
    echo

    echo "[Package]"
    R_LIBS_USER="$HOST_RLIB" Rscript --vanilla - <<'RS' || true
opts <- options(warn=1); on.exit(options(opts), add=TRUE)
.libPaths(c(Sys.getenv("R_LIBS_USER"), .libPaths()))
ok <- requireNamespace("dndsR", quietly=TRUE)
cat("installed:", ok, "\n")
if (ok) {
  cat("version:", as.character(utils::packageVersion("dndsR")), "\n")
}
RS
    ;;

  *) usage; exit 1 ;;
esac
