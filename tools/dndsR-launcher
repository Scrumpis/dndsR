#!/usr/bin/env bash
set -euo pipefail

die(){ echo "Error: $*" >&2; exit 1; }
have(){ command -v "$1" >/dev/null 2>&1; }

# Resolve directory of this script (even if invoked via relative path)
SCRIPT_SOURCE="${BASH_SOURCE[0]:-$0}"
while [ -h "$SCRIPT_SOURCE" ]; do
  DIR="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)"
  SCRIPT_SOURCE="$(readlink "$SCRIPT_SOURCE")"
  [[ $SCRIPT_SOURCE != /* ]] && SCRIPT_SOURCE="$DIR/$SCRIPT_SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SCRIPT_SOURCE")" && pwd)"

# Default repo dir: try to infer from launcher location, but allow override via REPO_DIR
infer_repo_dir() {
  # If user set REPO_DIR, respect it
  if [[ -n "${REPO_DIR:-}" ]]; then
    echo "${REPO_DIR}"
    return 0
  fi

  # Start from where this launcher lives
  local d="$SCRIPT_DIR"
  local i

  # Walk up a few levels and pick the first directory that looks like a dndsR repo root
  # (contains Rlibrary/DESCRIPTION for your current layout)
  for i in 0 1 2 3 4; do
    if [[ -f "${d}/Rlibrary/DESCRIPTION" ]]; then
      echo "${d}"
      return 0
    fi
    d="$(cd "${d}/.." && pwd)"
  done

  # Could not infer
  echo ""
  return 0
}

REPO_DIR="$(infer_repo_dir)"
PKG_DIR="Rlibrary"
PKG_NAME="dndsR"

[[ -f "${REPO_DIR}/${PKG_DIR}/DESCRIPTION" ]] || die \
"Could not locate ${PKG_DIR}/DESCRIPTION.
Set REPO_DIR=/path/to/dndsR repo root (the directory containing ${PKG_DIR}/)."

# default install location; override safely in SLURM with HOST_RLIB or SINGULARITYENV_HOST_RLIB
HOST_RLIB="${HOST_RLIB:-${HOME:-}/.dndsr/rlib}"

# ---- shim config (simple & predictable) ----
WITH_SHIMS="${WITH_SHIMS:-0}"            # install-time: create/refresh shims
USE_SHIMS="${USE_SHIMS:-0}"              # run-time: prepend shimdir to PATH
AUTO_SHIMS="${AUTO_SHIMS:-1}"            # run-time: if RUN_PREFIX set & shims exist, use them automatically
SHIMS_DIR_DEFAULT="${HOME:-}/.dndsr/shims"
SHIMS_DIR="${SHIMS_DIR:-$SHIMS_DIR_DEFAULT}"
TOOLS_DEFAULT="diamond,orthofinder,mafft,muscle,blastp,blastn,makeblastdb"
SHIMS_TOOLS="${DNDSR_SHIMS_TOOLS:-$TOOLS_DEFAULT}"

# container prefix used by shims (empty = host/conda PATH)
RUN_PREFIX_DEFAULT="${RUN_PREFIX:-}"     # e.g., 'singularity exec /path/dndsr.sif'
EMIT_RC="${EMIT_RC:-0}"

# global force from flag or env
FORCE="${DNDSR_FORCE:-0}"

# ------------- CLI entrypoint resolver -------------
resolve_cli(){
  # Allow override
  if [[ -n "${DNDSR_CLI:-}" ]]; then
    [[ -f "$DNDSR_CLI" ]] || die "DNDSR_CLI set but file not found: $DNDSR_CLI"
    echo "$DNDSR_CLI"
    return
  fi

  # Try common locations (support old + new layouts)
  local candidates=(
    "${REPO_DIR}/${PKG_DIR}/cli/dndsR.R"
    "${REPO_DIR}/${PKG_DIR}/R/cli_main.R"
    "${REPO_DIR}/Rlibrary/cli/dndsR.R"
    "${REPO_DIR}/Rlibrary/R/cli_main.R"
  )

  for p in "${candidates[@]}"; do
    if [[ -f "$p" ]]; then
      echo "$p"
      return
    fi
  done

  die "Could not find dndsR CLI entrypoint.
Tried:
  - ${candidates[*]}
Set DNDSR_CLI=/path/to/cli_main.R (or dndsR.R) to override."
}

usage(){
cat <<'EOF'
dndsR-launcher â€” install and run the dndsR CLI (container-agnostic)

USAGE
  dndsR-launcher [--force] [--with-shims] [--shims-dir DIR] [--tools LIST] [--run-prefix STR] [--emit-rc] install
  dndsR-launcher [--force] [--use-shims]  [--shims-dir DIR]                  [--run-prefix STR] run <dndsR subcommand> [args...]
  dndsR-launcher doctor

FLAGS
  --force             Force reinstall even if version/hash unchanged (or DNDSR_FORCE=1)

  # Install-time shims
  --with-shims        Create/refresh shims (diamond/orthofinder/etc.) during 'install'
  --shims-dir DIR     Where to place shims (default: ~/.dndsr/shims or SHIMS_DIR)
  --tools LIST        Comma/space-separated tools to shim (default: "diamond,orthofinder,mafft,muscle,blastp,blastn,makeblastdb")
  --emit-rc           Write ~/.dndsr/env.sh that exports PATH+RUN_PREFIX (optional)

  # Run-time shims
  --use-shims         Prepend existing shims to PATH for this invocation (does not create shims)
                      (By default, shims are auto-used if RUN_PREFIX is set and shims exist; disable via AUTO_SHIMS=0)
  --run-prefix STR    Prefix executed by shims (e.g., 'singularity exec /path/dndsr.sif' or 'docker run --rm ...')
                      (also configurable via RUN_PREFIX env var)

ENV (optional)
  HOST_RLIB           R library for dndsR (default: ~/.dndsr/rlib)
  REPO_DIR            repo root containing Rlibrary/
  DNDSR_FORCE=1       force reinstall
  SHIMS_DIR           default shim directory if --shims-dir not given
  DNDSR_SHIMS_TOOLS   default tool list for shims
  RUN_PREFIX          default run prefix if --run-prefix not given
  AUTO_SHIMS=0        disable auto-using shims when RUN_PREFIX is set and shims exist

EXAMPLES
  # Install pkg + create shims, set container prefix, and emit activation snippet
  dndsR-launcher --with-shims --shims-dir "$HOME/.dndsr/shims" \
    --run-prefix "singularity exec /path/dndsr.sif" --emit-rc install
  source "$HOME/.dndsr/env.sh"

  # One-off run using existing shims without touching shell RC
  dndsR-launcher --use-shims --run-prefix "singularity exec /path/dndsr.sif" run calculate_dnds --threads 16

  # Host/conda-only (no shims): just ensure tools are on PATH
  dndsR-launcher run calculate_dnds --threads 16
EOF
}

# ------------- helper: compute source hash -------------
src_hash(){
  local SUM=""
  have sha256sum && SUM="sha256sum" || have shasum && SUM="shasum -a 256" || SUM="md5sum"
  (
    cd "${REPO_DIR}/${PKG_DIR}" || exit 1
    find DESCRIPTION NAMESPACE R inst -type f 2>/dev/null | LC_ALL=C sort | xargs ${SUM} | ${SUM%% *} | awk '{print $1}'
  )
}

# ------------- shims -------------
_make_shims(){
  local outdir="$1"
  local list="$2"
  mkdir -p "$outdir"
  local IFS=', '
  read -r -a tools <<< "$list"
  for t in "${tools[@]}"; do
    [[ -z "$t" ]] && continue
    cat > "${outdir}/${t}" <<EOF
#!/usr/bin/env bash
set -euo pipefail
if [[ -n "\${RUN_PREFIX:-}" ]]; then
  exec \${RUN_PREFIX} ${t} "\$@"
else
  exec ${t} "\$@"
fi
EOF
    chmod +x "${outdir}/${t}"
  done
  echo "Wrote shims to ${outdir}/"
}

_emit_rc_snippet(){
  local rc="${HOME:-}/.dndsr/env.sh"
  mkdir -p "$(dirname "$rc")"
  cat > "$rc" <<EOF
# dndsR environment (generated by dndsR-launcher)
# shellcheck shell=bash
export PATH="${SHIMS_DIR}:\${PATH}"
${RUN_PREFIX_DEFAULT:+export RUN_PREFIX="${RUN_PREFIX_DEFAULT}"}
EOF
  echo "Wrote activation snippet: $rc"
  echo "To activate now:  source \"$rc\""
}

# ------------- install pkg if needed -------------
install_pkg_if_needed(){
  # Prevent bspm activity
  export R_PROFILE=/dev/null
  export R_PROFILE_USER=/dev/null
  export R_ENVIRON_USER=/dev/null
  export BSPM_DISABLE=1

  have R || die "R not found in PATH"
  have Rscript || die "Rscript not found in PATH"

  [[ -n "${HOST_RLIB}" ]] || die "HOST_RLIB is empty; set HOST_RLIB or HOME"
  mkdir -p "${HOST_RLIB}" || die "Failed to create ${HOST_RLIB}"
  [[ -w "${HOST_RLIB}" ]] || die "User library not writable: ${HOST_RLIB}"

  local desc="${REPO_DIR}/${PKG_DIR}/DESCRIPTION"
  [[ -f "$desc" ]] || die "No DESCRIPTION at ${desc}"

  local ver; ver="$(awk -F': *' '$1=="Version"{print $2}' "$desc")"
  [[ -n "$ver" ]] || die "Could not parse Version from DESCRIPTION"

  local hash; hash="$(src_hash || true)"
  [[ -n "$hash" ]] || echo "Warning: could not compute source hash; falling back to version only." >&2

  local meta="${HOST_RLIB}/.${PKG_NAME}.installmeta"
  local need=1
  if [[ -f "$meta" ]]; then
    read -r prev_ver prev_hash < "$meta" || true
    if [[ "${FORCE}" -eq 0 && "${prev_ver:-}" == "$ver" && ( -z "$hash" || "${prev_hash:-}" == "$hash" ) ]]; then
      need=0
    fi
  fi

  if [[ "${FORCE}" -eq 1 ]]; then
    echo "[${PKG_NAME}] FORCE reinstall requested."
    need=1
  fi

  if [[ "$need" -eq 0 ]]; then
    echo "[${PKG_NAME}] ${ver} already installed in ${HOST_RLIB} (hash match)."
  else
    echo "[${PKG_NAME}] Installing ${ver} into ${HOST_RLIB} ..."
    R CMD REMOVE -l "${HOST_RLIB}" "${PKG_NAME}" >/dev/null 2>&1 || true
    Rscript --vanilla -e "install.packages(normalizePath('${REPO_DIR}/${PKG_DIR}'), repos=NULL, type='source', lib='${HOST_RLIB}', INSTALL_opts=c('--clean','--preclean'))"
    echo "${ver} ${hash:-nohash}" > "$meta"
  fi

  R_LIBS_USER="${HOST_RLIB}" Rscript --vanilla - <<'RS'
opts <- options(warn=1); on.exit(options(opts), add=TRUE)
.libPaths(c(Sys.getenv("R_LIBS_USER"), .libPaths()))
suppressPackageStartupMessages(library(dndsR))
cat(sprintf("dndsR version: %s\n", as.character(packageVersion("dndsR"))))
cat("libPaths:\n"); print(.libPaths())
RS
}

# ------------- parse flags -------------
cmd=
RUN_PREFIX_ARG="$RUN_PREFIX_DEFAULT"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --force) FORCE=1; shift ;;
    --with-shims) WITH_SHIMS=1; shift ;;    # install-time
    --use-shims)  USE_SHIMS=1; shift ;;     # run-time (explicit)
    --shims-dir) SHIMS_DIR="${2:?}"; shift 2 ;;
    --tools) SHIMS_TOOLS="${2:?}"; shift 2 ;;
    --run-prefix) RUN_PREFIX_ARG="${2:?}"; shift 2 ;;
    --emit-rc) EMIT_RC=1; shift ;;
    install|run|doctor) cmd="$1"; shift; break ;;
    -h|--help|"") usage; exit 0 ;;
    *) usage; exit 1 ;;
  esac
done
[[ -n "${cmd:-}" ]] || { usage; exit 1; }

# make RUN_PREFIX visible to children if provided
if [[ -n "$RUN_PREFIX_ARG" ]]; then
  export RUN_PREFIX="$RUN_PREFIX_ARG"
fi

# ------------- commands -------------
case "$cmd" in
  install)
    install_pkg_if_needed
    if [[ "$WITH_SHIMS" -eq 1 ]]; then
      _make_shims "$SHIMS_DIR" "$SHIMS_TOOLS"
      export PATH="$SHIMS_DIR:$PATH"   # handy for this shell; permanence via env.sh
      [[ "$EMIT_RC" -eq 1 ]] && _emit_rc_snippet
      echo "Shims ready at $SHIMS_DIR."
      [[ "$EMIT_RC" -eq 0 ]] && echo "Tip: export PATH=\"$SHIMS_DIR:\$PATH\" (or re-run with --emit-rc)."
    fi
    echo "Installed/updated $PKG_NAME into $HOST_RLIB"
    ;;

  run)
    install_pkg_if_needed
    export R_LIBS_USER="$HOST_RLIB"

    # 1) explicit request
    if [[ "$USE_SHIMS" -eq 1 ]]; then
      if [[ -d "$SHIMS_DIR" && -n "$(ls -A "$SHIMS_DIR" 2>/dev/null || true)" ]]; then
        export PATH="$SHIMS_DIR:$PATH"
      else
        echo "Warning: --use-shims set but no shims in $SHIMS_DIR. Run 'install --with-shims' first." >&2
      fi
    # 2) automatic convenience: if RUN_PREFIX is set and shims exist, use them
    elif [[ "${AUTO_SHIMS}" -eq 1 && -n "${RUN_PREFIX:-}" && -d "$SHIMS_DIR" && -n "$(ls -A "$SHIMS_DIR" 2>/dev/null || true)" ]]; then
      export PATH="$SHIMS_DIR:$PATH"
    fi

    export DNDSR_HOME="${REPO_DIR}"
    export DNDSR_REPO="${REPO_DIR}"   # optional alias; harmless

    CLI_PATH="$(resolve_cli)"
    exec Rscript --vanilla "$CLI_PATH" "$@"
    ;;

  doctor)
    echo "=== dndsR doctor ==="
    echo "REPO_DIR:     $REPO_DIR"
    echo "HOST_RLIB:    $HOST_RLIB"
    echo "SHIMS_DIR:    $SHIMS_DIR"
    echo "RUN_PREFIX:   ${RUN_PREFIX:-<empty>}"
    echo "AUTO_SHIMS:   $AUTO_SHIMS"
    echo "CLI_PATH:     $(resolve_cli 2>/dev/null || echo "<not found>")"
    echo
    echo "[Package]"
    R_LIBS_USER="$HOST_RLIB" Rscript --vanilla - <<'RS' || true
opts <- options(warn=1); on.exit(options(opts), add=TRUE)
.libPaths(c(Sys.getenv("R_LIBS_USER"), .libPaths()))
ok <- requireNamespace("dndsR", quietly=TRUE)
cat("installed:", ok, "\n")
if (ok) {
  cat("version:", as.character(utils::packageVersion("dndsR")), "\n")
}
RS
    echo
    echo "[Shims]"
    if [[ -d "$SHIMS_DIR" ]]; then
      echo "exists: yes"
      ls -1 "$SHIMS_DIR" || true
    else
      echo "exists: no"
    fi
    echo
    echo "[Resolution]"
    for t in ${SHIMS_TOOLS//,/ }; do
      t="${t// /}"
      [[ -z "$t" ]] && continue
      echo -n "$t -> "
      command -v "$t" 2>/dev/null || echo "<not found>"
    done
    ;;

  *) usage; exit 1 ;;
esac
