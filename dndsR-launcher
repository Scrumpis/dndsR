#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="${REPO_DIR:-$PWD}"
PKG_DIR="Rlibrary"
HOST_RLIB="${HOST_RLIB:-$HOME/.dndsr/rlib}"

die(){ echo "Error: $*" >&2; exit 1; }

usage(){
cat <<EOF
dndsR-launcher - installs runs dndsR CLI

USAGE
  dndsR-launcher install
  dndsR-launcher run <args...>

ENV (optional)
  HOST_RLIB=~/.dndsr/rlib     # where the package is installed
  REPO_DIR=\$PWD               # repo root (containing Rlibrary/)
EOF
}

cmd="${1:-}"; shift || true
case "$cmd" in
  install|run) ;;
  -h|--help|"") usage; exit 0 ;;
  *) usage; exit 1 ;;
esac

install_pkg_if_needed(){
  mkdir -p "${HOST_RLIB}"
  local desc="${REPO_DIR}/${PKG_DIR}/DESCRIPTION"
  [[ -f "$desc" ]] || die "No DESCRIPTION at ${desc}"
  local ver; ver=$(awk -F': *' '$1=="Version"{print $2}' "$desc")
  local vfile="${HOST_RLIB}/.dndsR.version"
  if [[ -f "$vfile" ]] && [[ "$(cat "$vfile")" == "$ver" ]]; then
    return 0
  fi
  R CMD INSTALL --library="${HOST_RLIB}" "${REPO_DIR}/${PKG_DIR}"
  echo "$ver" > "$vfile"
}

case "$cmd" in
  install)
    install_pkg_if_needed
    echo "Installed/updated dndsR into ${HOST_RLIB}"
    ;;
  run)
    install_pkg_if_needed
    R_LIBS_USER="${HOST_RLIB}" Rscript "${REPO_DIR}/${PKG_DIR}/cli/dndsR.R" "$@"
    ;;
esac
