#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="${REPO_DIR:-$PWD}"
PKG_DIR="Rlibrary"
HOST_RLIB="${HOST_RLIB:-$HOME/.dndsr/rlib}"
FORCE=0

die(){ echo "Error: $*" >&2; exit 1; }
have(){ command -v "$1" >/dev/null 2>&1; }

usage(){
cat <<'EOF'
dndsR-launcher â€” installs and runs the dndsR CLI (container-agnostic)

USAGE
  dndsR-launcher install [--force]
  dndsR-launcher run <args...>

ENV (optional)
  HOST_RLIB=~/.dndsr/rlib   # where the package is installed
  REPO_DIR=$PWD             # repo root (containing Rlibrary/)
EOF
}

cmd="${1:-}"; shift || true
case "${cmd}" in
  install|run) ;;
  -h|--help|"") usage; exit 0 ;;
  *) usage; exit 1 ;;
esac

# parse flags for install
if [[ "${cmd}" == "install" ]]; then
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --force) FORCE=1; shift ;;
      --) shift; break ;;
      *) break ;;
    esac
  done
fi

install_pkg_if_needed(){
  have R || die "R not found in PATH"
  have Rscript || die "Rscript not found in PATH"

  mkdir -p "${HOST_RLIB}"
  [[ -w "${HOST_RLIB}" ]] || die "User library not writable: ${HOST_RLIB}"

  local desc="${REPO_DIR}/${PKG_DIR}/DESCRIPTION"
  [[ -f "$desc" ]] || die "No DESCRIPTION at ${desc}"
  local ver; ver="$(awk -F': *' '$1=="Version"{print $2}' "$desc")"
  [[ -n "$ver" ]] || die "Could not parse Version from DESCRIPTION"

  local vfile="${HOST_RLIB}/.dndsR.version"
  if [[ ${FORCE} -eq 0 && -f "${vfile}" && "$(cat "${vfile}")" == "${ver}" ]]; then
    echo "dndsR ${ver} already installed in ${HOST_RLIB} (use --force to reinstall)."
  else
    R CMD INSTALL --library="${HOST_RLIB}" "${REPO_DIR}/${PKG_DIR}"
    echo "${ver}" > "${vfile}"
  fi

  # quick load test with the same lib path
  R_LIBS_USER="${HOST_RLIB}" Rscript - <<'RS'
opts <- options(warn=1); on.exit(options(opts), add=TRUE)
.libPaths(c(Sys.getenv("R_LIBS_USER"), .libPaths()))
suppressPackageStartupMessages(library(dndsR))
cat(sprintf("dndsR version: %s\n", as.character(packageVersion("dndsR"))))
cat("libPaths:\n"); print(.libPaths())
RS
}

case "${cmd}" in
  install)
    install_pkg_if_needed
    echo "Installed/updated dndsR into ${HOST_RLIB}"
    ;;

  run)
    install_pkg_if_needed
    export R_LIBS_USER="${HOST_RLIB}"
    # exec so signals/exit codes propagate
    exec Rscript "${REPO_DIR}/${PKG_DIR}/cli/dndsR.R" "$@"
    ;;
esac
